echo "🏗️  Building project..."
npm run build || exit 1

echo "🧪 Running tests with coverage..."
npm run test:cov || exit 1

COVERAGE_THRESHOLD=80
ACTUAL_COVERAGE=$(cat coverage/coverage-final.json | grep -o '"total":{"lines":{"pct":[0-9.]*' | grep -o '[0-9.]*$')

if (( $(echo "$ACTUAL_COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
  echo "❌ Test coverage ($ACTUAL_COVERAGE%) is below the required threshold ($COVERAGE_THRESHOLD%)"
  exit 1
fi

echo "✅ All checks passed!"